(window.webpackJsonp_2ea4494a4801c9aca03bba9314014278=window.webpackJsonp_2ea4494a4801c9aca03bba9314014278||[]).push([[15],{GaMX:function(e,t,n){"use strict";n.r(t),n.d(t,"EntityType",function(){return p}),n.d(t,"MicrosoftSearchDataSource",function(){return D});var a,i=n("UDSP"),r=n("26ea"),o=n("Pk8u"),s=n("vlQI"),c=n("tDQZ"),d=n("OuDy"),l=n("ci4p"),u=n("aFY1"),f=n("PqB8");!function(e){e.Count="count",e.KeyAsNumber="keyAsNumber",e.KeyAsString="keyAsString"}(a||(a={}));var p,m=n("UqOl"),_=n("/ED6"),h=n("hO2E"),b=n("tpj2"),g=n("cDcd"),v=n("vnLM"),y=n("rMgv"),S=function(e,t,n,a){return new(n||(n=Promise))(function(i,r){function o(e){try{c(a.next(e))}catch(e){r(e)}}function s(e){try{c(a.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(o,s)}c((a=a.apply(e,t||[])).next())})};!function(e){e.Message="message",e.Event="event",e.Drive="drive",e.DriveItem="driveItem",e.ExternalItem="externalItem",e.List="list",e.ListItem="listItem",e.Site="site",e.Person="person"}(p||(p={}));class D extends i.BaseDataSource{constructor(e){super(e),this._propertyPaneWebPartInformation=null,this._availableFields=[],this._sortableFields=y.n.map(e=>({key:e,text:e})),this._availableEntityTypeOptions=[{key:p.Message,text:"Messages"},{key:p.Event,text:"Events"},{key:p.Drive,text:"Drive"},{key:p.DriveItem,text:"Drive Items"},{key:p.ExternalItem,text:"External Items"},{key:p.ListItem,text:"List Items"},{key:p.List,text:"List"},{key:p.Site,text:"Sites"},{key:p.Person,text:"People"}],this._itemsCount=0,this._propertyFieldCollectionData=null,this._customCollectionFieldType=null,e.whenFinished(()=>{this._tokenService=e.consume(c.t.ServiceKey)})}onInit(){return S(this,void 0,void 0,function*(){if(this.dateHelper=this.serviceScope.consume(m.e.ServiceKey),this.moment=yield this.dateHelper.moment(),this.editMode){const{PropertyFieldCollectionData:e,CustomCollectionFieldType:t}=yield Promise.all([n.e(3),n.e(2),n.e(4),n.e(5),n.e(16)]).then(n.bind(null,"2LYl")),{PropertyPaneWebPartInformation:a}=yield Promise.all([n.e(3),n.e(2),n.e(4),n.e(5),n.e(16)]).then(n.bind(null,"Wluh"));this._propertyPaneWebPartInformation=a,this._propertyFieldCollectionData=e,this._customCollectionFieldType=t}this.initProperties()})}getItemCount(){return this._itemsCount}getFilterBehavior(){return i.FilterBehavior.Dynamic}getPagingBehavior(){return i.PagingBehavior.Dynamic}getData(e){return S(this,void 0,void 0,function*(){let t={items:[]};if(this._properties.entityTypes.length>0){const n=yield this.buildMicrosoftSearchQuery(e);t=yield this.search(n)}else this._itemsCount=0;return t})}getPropertyPaneGroupsConfiguration(){const e=this._availableEntityTypeOptions.map(e=>{if(-1!==this.properties.entityTypes.indexOf(e.key))return e.text});let t=[],n=[],a=[],o=[],s=[Object(r.PropertyPaneLabel)("",{text:f.DataSources.MicrosoftSearch.QueryTextFieldLabel}),this._propertyPaneWebPartInformation({description:`<em>${f.DataSources.MicrosoftSearch.QueryTextFieldInfoMessage}</em>`,key:"queryText"}),new b.e("dataSourceProperties.queryTemplate",{componentKey:`${v.t.MicrosoftSearch}-queryTemplate`,defaultValue:this.properties.queryTemplate,label:f.DataSources.MicrosoftSearch.QueryTemplateFieldLabel,placeholderText:f.DataSources.MicrosoftSearch.QueryTemplatePlaceHolderText,multiline:!0,description:f.DataSources.MicrosoftSearch.QueryTemplateFieldDescription,applyBtnText:f.DataSources.MicrosoftSearch.ApplyQueryTemplateBtnText,allowEmptyValue:!1,rows:8}),new u.e("dataSourceProperties.entityTypes",{availableOptions:this._availableEntityTypeOptions,allowMultiSelect:!0,allowFreeform:!1,description:"",label:f.DataSources.MicrosoftSearch.EntityTypesField,placeholder:"",searchAsYouType:!1,defaultSelectedKeys:this.properties.entityTypes,onPropertyChange:this.onCustomPropertyUpdate.bind(this),textDisplayValue:e.filter(e=>e).join(",")}),new u.e("dataSourceProperties.fields",{availableOptions:this._availableFields,allowMultiSelect:!0,allowFreeform:!0,description:f.DataSources.MicrosoftSearch.SelectedFieldsPropertiesFieldDescription,label:f.DataSources.MicrosoftSearch.SelectedFieldsPropertiesFieldLabel,placeholder:f.DataSources.MicrosoftSearch.SelectedFieldsPlaceholderLabel,searchAsYouType:!1,defaultSelectedKeys:this.properties.fields,onPropertyChange:this.onCustomPropertyUpdate.bind(this),onUpdateOptions:(e=>{this._availableFields=e}).bind(this)}),Object(r.PropertyPaneToggle)("dataSourceProperties.enableResultTypes",{label:"Enable result types",disabled:-1===this.properties.entityTypes.indexOf(p.ExternalItem)})],c=[Object(r.PropertyPaneHorizontalRule)(),Object(r.PropertyPaneToggle)("dataSourceProperties.useBetaEndpoint",{label:f.DataSources.MicrosoftSearch.UseBetaEndpoint})];this.properties.useBetaEndpoint&&c.push(Object(r.PropertyPaneToggle)("dataSourceProperties.trimDuplicates",{label:f.DataSources.MicrosoftSearch.TrimDuplicates}),Object(r.PropertyPaneHorizontalRule)()),-1===this.properties.entityTypes.indexOf(p.DriveItem)&&-1===this.properties.entityTypes.indexOf(p.ListItem)&&-1===this.properties.entityTypes.indexOf(p.Site)&&-1===this.properties.entityTypes.indexOf(p.List)||a.push(this._propertyFieldCollectionData("dataSourceProperties.sortProperties",{manageBtnLabel:f.DataSources.SearchCommon.Sort.EditSortLabel,key:"sortProperties",enableSorting:!0,panelHeader:f.DataSources.SearchCommon.Sort.EditSortLabel,panelDescription:f.DataSources.SearchCommon.Sort.SortListDescription,label:f.DataSources.SearchCommon.Sort.SortPropertyPaneFieldLabel,value:this.properties.sortProperties,fields:[{id:"sortField",title:f.DataSources.SearchCommon.Sort.SortFieldColumnLabel,type:this._customCollectionFieldType.custom,required:!0,onCustomRender:((e,t,n,a,i,r)=>g.createElement("div",{key:`${e.id}-${i}`},g.createElement(h.e,{defaultSelectedKey:a[e.id]?a[e.id]:"",allowMultiSelect:!1,allowFreeform:!0,availableOptions:this._sortableFields,onUpdateOptions:(e=>{this._sortableFields=e}).bind(this),clearTextOnFocus:!0,onUpdate:t=>{n(e.id,t.key)},placeholder:f.DataSources.SearchCommon.Sort.SortFieldColumnPlaceholder,useComboBoxAsMenuWidth:!1}))).bind(this)},{id:"isDefaultSort",title:f.DataSources.SearchCommon.Sort.SortFieldDefaultSortLabel,type:this._customCollectionFieldType.boolean},{id:"sortDirection",title:f.DataSources.SearchCommon.Sort.SortDirectionColumnLabel,type:this._customCollectionFieldType.custom,onCustomRender:(e,t,n,a)=>g.createElement("div",null,g.createElement(d.e,{options:[{key:i.SortFieldDirection.Ascending,text:f.DataSources.SearchCommon.Sort.SortDirectionAscendingLabel},{key:i.SortFieldDirection.Descending,text:f.DataSources.SearchCommon.Sort.SortDirectionDescendingLabel}],disabled:!a.isDefaultSort,defaultSelectedKey:a.sortDirection?a.sortDirection:i.SortFieldDirection.Ascending,onChange:(t,a)=>n(e.id,a.key)}))},{id:"isUserSort",title:f.DataSources.SearchCommon.Sort.SortFieldUserSortLabel,type:this._customCollectionFieldType.boolean},{id:"sortFieldDisplayName",title:f.DataSources.SearchCommon.Sort.SortFieldFriendlyNameLabel,type:this._customCollectionFieldType.custom,onCustomRender:(e,t,n,a)=>g.createElement("div",null,g.createElement(l.e,{defaultValue:t,disabled:!a.isUserSort,onChange:(t,a)=>{n(e.id,a)}}))}]})),-1!==this.properties.entityTypes.indexOf(p.ExternalItem)&&t.push(new u.e("dataSourceProperties.contentSourceConnectionIds",{availableOptions:[],allowMultiSelect:!0,allowFreeform:!0,description:f.DataSources.MicrosoftSearch.ContentSourcesFieldDescriptionLabel,label:f.DataSources.MicrosoftSearch.ContentSourcesFieldLabel,placeholder:f.DataSources.MicrosoftSearch.ContentSourcesFieldPlaceholderLabel,searchAsYouType:!1,defaultSelectedKeys:this.properties.contentSourceConnectionIds,onPropertyChange:this.onCustomPropertyUpdate.bind(this)})),-1!==this.properties.entityTypes.indexOf(p.Message)&&1===this.properties.entityTypes.length&&n.push(Object(r.PropertyPaneToggle)("dataSourceProperties.enableTopResults",{label:f.DataSources.MicrosoftSearch.EnableTopResultsLabel})),-1===this.properties.entityTypes.indexOf(p.Message)&&-1===this.properties.entityTypes.indexOf(p.Event)&&-1===this.properties.entityTypes.indexOf(p.Site)&&-1===this.properties.entityTypes.indexOf(p.Drive)&&-1===this.properties.entityTypes.indexOf(p.DriveItem)&&-1===this.properties.entityTypes.indexOf(p.List)&&-1===this.properties.entityTypes.indexOf(p.ListItem)&&-1===this.properties.entityTypes.indexOf(p.ExternalItem)||o.push(Object(r.PropertyPaneToggle)("dataSourceProperties.queryAlterationOptions.enableSuggestion",{label:f.DataSources.MicrosoftSearch.EnableSuggestionLabel,checked:this.properties.queryAlterationOptions.enableSuggestion}),Object(r.PropertyPaneToggle)("dataSourceProperties.queryAlterationOptions.enableModification",{label:f.DataSources.MicrosoftSearch.EnableModificationLabel,checked:this.properties.queryAlterationOptions.enableModification}));let m=[...s,...a,...n,...t,...c,...o];return[{groupName:f.DataSources.MicrosoftSearch.SourceConfigurationGroupName,groupFields:m}]}onPropertyUpdate(e,t,n){0===e.localeCompare("dataSourceProperties.useBetaEndpoint")&&(this._microsoftSearchUrl=n?"https://graph.microsoft.com/beta/search/query":"https://graph.microsoft.com/v1.0/search/query"),0===e.localeCompare("dataSourceProperties.sortProperties")&&(this.properties.sortList=n)}onCustomPropertyUpdate(e,t,n){if(0===e.localeCompare("dataSourceProperties.entityTypes")&&(this.properties.entityTypes=Object(o.cloneDeep)(t).map(e=>e.key),-1===this.properties.entityTypes.indexOf(p.ExternalItem)&&(this.properties.enableResultTypes=!1),this.context.propertyPane.refresh(),this.render()),0===e.localeCompare("dataSourceProperties.fields")){let e=this.parseAndCleanOptions(Object(o.cloneDeep)(t));this.properties.fields=e.map(e=>e.key),this.context.propertyPane.refresh(),this.render()}0===e.localeCompare("dataSourceProperties.contentSourceConnectionIds")&&(this.properties.contentSourceConnectionIds=Object(o.cloneDeep)(t).map(e=>e.key),this.context.propertyPane.refresh(),this.render())}getTemplateSlots(){return[{slotName:i.BuiltinTemplateSlots.Title,slotField:"resource.name"},{slotName:i.BuiltinTemplateSlots.Path,slotField:"resource.webUrl"},{slotName:i.BuiltinTemplateSlots.Summary,slotField:"summary"},{slotName:i.BuiltinTemplateSlots.FileType,slotField:"resource.webUrl"},{slotName:i.BuiltinTemplateSlots.PreviewImageUrl,slotField:"AutoPreviewImageUrl"},{slotName:i.BuiltinTemplateSlots.PreviewUrl,slotField:"AutoPreviewUrl"},{slotName:i.BuiltinTemplateSlots.Tags,slotField:"owstaxidmetadataalltagsinfo"},{slotName:i.BuiltinTemplateSlots.Date,slotField:"created"},{slotName:i.BuiltinTemplateSlots.SiteId,slotField:"resource.fields.normSiteID"},{slotName:i.BuiltinTemplateSlots.WebId,slotField:"resource.fields.normWebID"},{slotName:i.BuiltinTemplateSlots.ListId,slotField:"resource.fields.normListID"},{slotName:i.BuiltinTemplateSlots.ItemId,slotField:"resource.fields.normUniqueID"},{slotName:i.BuiltinTemplateSlots.IsFolder,slotField:"resource.fields.contentTypeId"},{slotName:i.BuiltinTemplateSlots.Id,slotField:"hitId"}]}getSortableFields(){return this.properties.sortProperties.filter(e=>e.isUserSort).map(e=>e.sortField)}initProperties(){var e;this.properties.entityTypes=void 0!==this.properties.entityTypes?this.properties.entityTypes:[p.DriveItem],this.properties.fields=void 0!==this.properties.fields?this.properties.fields:["name","webUrl","filetype","createdBy","createdDateTime","lastModifiedDateTime","parentReference","size","description","file","folder","subject","bodyPreview","replyTo","from","sender","start","end","displayName","givenName","surname","userPrincipalName","phones","department"],this.properties.sortProperties=void 0!==this.properties.sortProperties?this.properties.sortProperties:[],this.properties.sortList=this.properties.sortProperties,this.properties.contentSourceConnectionIds=void 0!==this.properties.contentSourceConnectionIds?this.properties.contentSourceConnectionIds:[],this.properties.queryAlterationOptions=null!==(e=this.properties.queryAlterationOptions)&&void 0!==e?e:{enableModification:!1,enableSuggestion:!1},this.properties.queryTemplate=this.properties.queryTemplate?this.properties.queryTemplate:"{searchTerms}",this.properties.useBetaEndpoint=void 0!==this.properties.useBetaEndpoint&&this.properties.useBetaEndpoint,this.properties.enableResultTypes=void 0!==this.properties.enableResultTypes&&this.properties.enableResultTypes,this.properties.trimDuplicates=void 0!==this.properties.trimDuplicates&&this.properties.trimDuplicates,this.properties.useBetaEndpoint?this._microsoftSearchUrl="https://graph.microsoft.com/beta/search/query":this._microsoftSearchUrl="https://graph.microsoft.com/v1.0/search/query"}buildMicrosoftSearchQuery(e){var t,n;return S(this,void 0,void 0,function*(){let r={requests:[]},s=[],c=[],d=[],l=[],u="*",f=0;e.inputQueryText&&(u=yield this._tokenService.resolveTokens(e.inputQueryText));let m=yield this._tokenService.resolveTokens(this.properties.queryTemplate);if(Object(o.isEmpty)(m.trim())||this.properties.useBetaEndpoint||(u=m.trim()),e.pageNumber>1&&(f=(e.pageNumber-1)*e.itemsCountPerPage),s=e.filters.filtersConfiguration.map(e=>{let t={field:e.filterName,bucketDefinition:{isDescending:e.sortDirection!==i.FilterSortDirection.Ascending,minimumCount:0,sortBy:e.sortBy===i.FilterSortType.ByCount?a.Count:a.KeyAsString},size:e&&e.maxBuckets?e.maxBuckets:10};if("DateIntervalFilterTemplate"===e.selectedTemplate){const e=this.moment(new Date).subtract(1,"years").subtract("minutes",1).toISOString(),n=this.moment(new Date).subtract(3,"months").subtract("minutes",1).toISOString(),a=this.moment(new Date).subtract(1,"months").subtract("minutes",1).toISOString(),i=this.moment(new Date).subtract(1,"week").subtract("minutes",1).toISOString(),r=this.moment(new Date).subtract(24,"hours").subtract("minutes",1).toISOString(),o=(new Date).toISOString();t.bucketDefinition.ranges=[{to:e},{from:e,to:n},{from:n,to:a},{from:a,to:i},{from:i,to:r},{from:r,to:o},{from:o}]}return t}),e.filters.selectedFilters.length>0)if(e.filters.selectedFilters.length>1&&e.filters.selectedFilters.filter(e=>e.values.length>0).length>1){const t=_.e.buildFqlRefinementString(e.filters.selectedFilters,e.filters.filtersConfiguration,this.moment).join(",");Object(o.isEmpty)(t)||(c=c.concat([`${e.filters.filterOperator}(${t})`]))}else c=c.concat(_.e.buildFqlRefinementString(e.filters.selectedFilters,e.filters.filtersConfiguration,this.moment));-1!==this.properties.entityTypes.indexOf(p.ExternalItem)&&this.properties.contentSourceConnectionIds.forEach(e=>{l.push(`/external/connections/${e}`)}),-1!==this.properties.entityTypes.indexOf(p.ListItem)&&((null===(t=e.sorting)||void 0===t?void 0:t.selectedSortFieldName)&&(null===(n=e.sorting)||void 0===n?void 0:n.selectedSortDirection)?d.push({name:e.sorting.selectedSortFieldName,isDescending:e.sorting.selectedSortDirection===i.SortFieldDirection.Descending}):this.properties.sortProperties.filter(e=>e.sortField).forEach(e=>{d.push({name:e.sortField,isDescending:e.sortDirection===i.SortFieldDirection.Descending})}));let h={entityTypes:this.properties.entityTypes,query:{queryString:u,queryTemplate:m},from:f,size:e.itemsCountPerPage};return this.properties.fields.length>0&&(h.fields=this.properties.fields.filter(e=>e)),s.length>0&&(h.aggregations=s.filter(e=>e)),c.length>0&&(h.aggregationFilters=c),d.length>0&&(h.sortProperties=d),l.length>0&&(h.contentSources=l),this.properties.trimDuplicates&&(h.trimDuplicates=this.properties.trimDuplicates),h.queryAlterationOptions={enableModification:this.properties.queryAlterationOptions.enableModification,enableSuggestion:this.properties.queryAlterationOptions.enableSuggestion},this.properties.enableResultTypes&&(h.resultTemplateOptions={enableResultTemplate:!0}),r.requests.push(h),r})}search(e){return S(this,void 0,void 0,function*(){let t=0,n={items:[],filters:[]},a=[];const r=this.serviceScope.consume(s.MSGraphClientFactory.serviceKey),o=yield r.getClient(),c=yield o.api(this._microsoftSearchUrl),d=yield c.headers({SdkVersion:"pnpmodernsearch/"+this.context.manifest.version}).post(e);return d.value&&Array.isArray(d.value)&&d.value.forEach(e=>{e.hitsContainers.forEach(e=>{if(t+=e.total,e.hits){const t=e.hits.map(e=>(e.resource.fields&&Object.keys(e.resource.fields).forEach(t=>{e[t]=e.resource.fields[t]}),e));n.items=n.items.concat(t)}e.aggregations&&(e.aggregations.forEach(e=>{let t=[];e.buckets.forEach(e=>{t.push({count:e.count,name:e.key,value:e.aggregationFilterToken,operator:i.FilterComparisonOperator.Contains})}),a.push({filterName:e.field,values:t})}),n.filters=a)}),(null==e?void 0:e.queryAlterationResponse)&&(n.queryAlterationResponse=e.queryAlterationResponse),(null==e?void 0:e.resultTemplates)&&(n.resultTemplates=e.resultTemplates)}),this._itemsCount=t,n})}parseAndCleanOptions(e){let t=e.find(e=>e.key.indexOf(",")>0);return t?t.key.split(",").map(e=>({key:e.trim(),text:e.trim(),selected:!0})):e}}},tpj2:function(e,t,n){"use strict";n.d(t,"e",function(){return l});var a=n("cDcd"),i=n("faye"),r=n("26ea"),o=n("ci4p"),s=n("Dk3Y"),c=n("Pk8u");class d extends a.Component{constructor(e){super(e),this.state={value:e.defaultValue,iconName:null},this._onChange=this._onChange.bind(this),this._onApply=this._onApply.bind(this)}render(){const e=this.state.iconName?{iconProps:{iconName:this.state.iconName}}:null;let t=!this.state.value&&!this.props.allowEmptyValue||Object(c.isEqual)(this.state.value,this.props.defaultValue);return a.createElement(a.Fragment,null,a.createElement(o.e,{key:this.props.key,defaultValue:this.props.defaultValue,label:this.props.label,placeholder:this.props.placeholderText,description:this.props.description,multiline:this.props.multiline,autoAdjustHeight:this.props.multiline,rows:this.props.rows?this.props.rows:4,onChange:this._onChange}),a.createElement(s.e,Object.assign({toggle:!0,styles:{root:{marginTop:8}},text:this.props.applyBtnText,onClick:this._onApply,allowDisabledFocus:!0,disabled:t,checked:!0},e)))}componentDidUpdate(e,t){Object(c.isEqual)(e.defaultValue,this.props.defaultValue)||this.setState({value:this.props.defaultValue})}_onChange(e,t){this.setState({value:t,iconName:t!==this.props.defaultValue?"Save":null})}_onApply(){this.props.onUpdate(this.state.value),this.setState({iconName:"Accept"})}}class l{constructor(e,t){this.type=r.PropertyPaneFieldType.Custom,this.targetProperty=e,this.properties={componentKey:t.componentKey,key:t.componentKey,description:t.description,label:t.label,placeholderText:t.placeholderText,multiline:t.multiline,onRender:this.onRender.bind(this),onDispose:this.onDispose.bind(this),applyBtnText:t.applyBtnText,defaultValue:t.defaultValue,rows:t.rows,allowEmptyValue:t.allowEmptyValue}}render(){this.elem&&this.onRender(this.elem)}onDispose(e){i.unmountComponentAtNode(e)}onRender(e,t,n){this.elem||(this.elem=e);const r=a.createElement("div",{key:this.properties.key},a.createElement(d,{key:this.properties.componentKey,onUpdate:(e=>{n(this.targetProperty,e)}).bind(this),description:this.properties.description,label:this.properties.label,multiline:this.properties.multiline,placeholderText:this.properties.placeholderText,applyBtnText:this.properties.applyBtnText,defaultValue:this.properties.defaultValue,rows:this.properties.rows,allowEmptyValue:this.properties.allowEmptyValue}));i.render(r,e)}}}}]);